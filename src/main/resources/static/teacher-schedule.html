<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•™å¸ˆè¯¾ç¨‹è¡¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group label {
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }

        select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            min-width: 150px;
            cursor: pointer;
        }

        .schedule-wrapper {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 0 auto;
        }

        th, td {
            border: 1px solid #e0e0e0;
            text-align: left;
            vertical-align: middle;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            font-size: 15px;
            text-align: center;
            min-width: 140px;
            padding: 18px;
        }

        th.time-slot {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            min-width: 200px;
            padding: 18px;
        }

        td.date-cell {
            background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
            font-weight: bold;
            color: #FF6F00;
            font-size: 15px;
            text-align: center;
            min-width: 200px;
            padding: 15px;
        }

        td.course-cell {
            padding: 18px;
            min-width: 140px;
            background: white;
        }

        .student-list {
            display: flex;
            flex-wrap: nowrap;
            gap: 8px;
            justify-content: flex-start;
        }

        .student-name {
            display: inline-block;
            padding: 8px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.25);
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .student-name:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            cursor: pointer;
        }

        .student-name.on-leave {
            background: linear-gradient(135deg, #FF5722 0%, #F44336 100%);
            box-shadow: 0 3px 10px rgba(244, 67, 54, 0.3);
            opacity: 0.7;
        }

        .student-name.on-leave:hover {
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }

        .empty-cell {
            color: #ddd;
            font-size: 16px;
            text-align: center;
            padding: 25px;
            font-style: italic;
        }

        .loading, .error, .empty {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .error {
            background: rgba(244, 67, 54, 0.9);
            color: white;
        }

        .legend {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 13px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-sample {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            background: white;
            border: 1px solid #e0e0e0;
        }

        .legend-sample.on-leave {
            background: linear-gradient(135deg, #FF5722 0%, #F44336 100%);
            color: white;
            border-color: #FFCDD2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‘¨â€ğŸ« æ•™å¸ˆè¯¾ç¨‹è¡¨</h1>
            <div class="filters">
                <div class="filter-group">
                    <label>é€‰æ‹©æ•™å¸ˆï¼š</label>
                    <select id="teacherSelect">
                        <option value="">è¯·é€‰æ‹©æ•™å¸ˆ</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>é€‰æ‹©å­¦æœŸï¼š</label>
                    <select id="semesterSelect">
                        <option value="">è¯·é€‰æ‹©å­¦æœŸ</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="loading" class="loading">
            <div>â³ æ­£åœ¨åŠ è½½...</div>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="empty" class="empty" style="display: none;">
            <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“­</div>
            <div style="font-size: 18px; color: #666;">æš‚æ— æ’è¯¾æ•°æ®</div>
            <div style="font-size: 14px; color: #999; margin-top: 10px;">è¯·å…ˆé€‰æ‹©æ•™å¸ˆå’Œå­¦æœŸ</div>
        </div>

        <div id="scheduleWrapper" class="schedule-wrapper" style="display: none;">
            <table id="scheduleTable">
                <thead>
                    <tr id="headerRow">
                        <th class="time-slot">æ—¶é—´æ®µ</th>
                    </tr>
                </thead>
                <tbody id="scheduleBody">
                </tbody>
            </table>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-sample">å­¦ç”Ÿ</div>
                    <span>æ­£å¸¸ä¸Šè¯¾</span>
                </div>
                <div class="legend-item">
                    <div class="legend-sample on-leave">å­¦ç”Ÿ</div>
                    <span>å·²è¯·å‡</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';

        // æ—¶é—´æ®µå®šä¹‰
        const TIME_SLOTS = [
            { id: 1, name: 'ç¬¬1èŠ‚', time: '07:40-09:40' },
            { id: 2, name: 'ç¬¬2èŠ‚', time: '09:40-11:40' },
            { id: 3, name: 'ç¬¬3èŠ‚', time: '12:30-14:30' },
            { id: 4, name: 'ç¬¬4èŠ‚', time: '14:30-16:30' },
            { id: 5, name: 'ç¬¬5èŠ‚', time: '16:30-18:30' },
            { id: 6, name: 'ç¬¬6èŠ‚', time: '18:50-20:50' }
        ];

        let teachers = [];
        let semesters = [];
        let scheduleData = [];

        // åˆå§‹åŒ–
        async function init() {
            try {
                await Promise.all([loadTeachers(), loadSemesters()]);
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                showError('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨');
                console.error(error);
            }
        }

        // åŠ è½½æ•™å¸ˆåˆ—è¡¨
        async function loadTeachers() {
            const response = await fetch(`${API_BASE}/teacher`);
            teachers = await response.json();

            const select = document.getElementById('teacherSelect');
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.teacherId;
                option.textContent = teacher.teacherName;
                select.appendChild(option);
            });
        }

        // åŠ è½½å­¦æœŸåˆ—è¡¨
        async function loadSemesters() {
            try {
                const response = await fetch(`${API_BASE}/semester`);
                semesters = await response.json();

                console.log('åŠ è½½åˆ°çš„å­¦æœŸåˆ—è¡¨:', semesters);

                const select = document.getElementById('semesterSelect');
                select.innerHTML = '<option value="">è¯·é€‰æ‹©å­¦æœŸ</option>';
                semesters.forEach(semester => {
                    const option = document.createElement('option');
                    option.value = semester.semesterId;
                    option.textContent = semester.semesterName;
                    select.appendChild(option);
                });

                // è‡ªåŠ¨é€‰æ‹©å½“å‰è¿›è¡Œä¸­çš„å­¦æœŸ
                const current = semesters.find(s => s.status === 'è¿›è¡Œä¸­');
                if (current) {
                    select.value = current.semesterId;
                    console.log('è‡ªåŠ¨é€‰æ‹©å­¦æœŸ:', current.semesterName);
                }
            } catch (error) {
                console.error('åŠ è½½å­¦æœŸå¤±è´¥:', error);
            }
        }

        // åŠ è½½è¯¾ç¨‹è¡¨
        async function loadSchedule() {
            const teacherId = document.getElementById('teacherSelect').value;
            const semesterId = document.getElementById('semesterSelect').value;

            console.log('å¼€å§‹åŠ è½½è¯¾ç¨‹è¡¨ - æ•™å¸ˆID:', teacherId, 'å­¦æœŸID:', semesterId);

            if (!teacherId || !semesterId) {
                return;
            }

            showLoading();

            try {
                const url = `${API_BASE}/class-schedule/teacher-data/${teacherId}?semesterId=${semesterId}`;
                console.log('è¯·æ±‚URL:', url);

                const response = await fetch(url);
                if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');

                const allSchedules = await response.json();
                console.log('è·å–åˆ°çš„æ‰€æœ‰è¯¾ç¨‹æ•°æ®æ•°é‡:', allSchedules.length);

                if (allSchedules.length === 0) {
                    hideLoading();
                    document.getElementById('empty').style.display = 'block';
                    document.getElementById('scheduleWrapper').style.display = 'none';
                    return;
                }

                scheduleData = allSchedules;

                // è·å–æ‰€æœ‰å”¯ä¸€çš„æ—¥æœŸå¹¶æ’åº
                const allDates = [...new Set(scheduleData.map(s => s.courseDate))].sort();
                const dates = allDates; // æ˜¾ç¤ºæ‰€æœ‰è¯¾ç¨‹æ—¥æœŸ

                console.log('æ‰€æœ‰è¯¾ç¨‹æ—¥æœŸèŒƒå›´:', allDates);
                console.log('æ˜¾ç¤ºçš„æ—¥æœŸæ•°é‡:', dates.length);

                hideLoading();
                renderScheduleTable(dates);

            } catch (error) {
                hideLoading();
                showError('åŠ è½½è¯¾ç¨‹è¡¨å¤±è´¥ï¼š' + error.message);
                console.error('è¯¦ç»†é”™è¯¯:', error);
            }
        }

        // æ¸²æŸ“è¯¾ç¨‹è¡¨
        function renderScheduleTable(dates) {
            document.getElementById('scheduleWrapper').style.display = 'block';

            // è®¾ç½®è¡¨å¤´
            const headerRow = document.getElementById('headerRow');
            headerRow.innerHTML = '<th class="time-slot">æ—¶é—´æ®µ</th>';
            dates.forEach(date => {
                const dateObj = new Date(date);
                const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                const weekday = weekdays[dateObj.getDay()];
                const dateShort = formatDateShort(dateObj);

                const th = document.createElement('th');
                th.innerHTML = `${dateShort}<br><span style="font-size:12px;opacity:0.8">${weekday}</span>`;
                headerRow.appendChild(th);
            });

            // ç”Ÿæˆè¡¨æ ¼å†…å®¹
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';

            TIME_SLOTS.forEach(slot => {
                const tr = document.createElement('tr');

                // æ—¶é—´æ®µåˆ—
                const timeTd = document.createElement('td');
                timeTd.className = 'date-cell';
                timeTd.innerHTML = `${slot.name}<br><span style="font-size:12px;color:#666">${slot.time}</span>`;
                tr.appendChild(timeTd);

                // æ¯ä¸ªæ—¥æœŸçš„åˆ—
                dates.forEach(date => {
                    const td = document.createElement('td');
                    td.className = 'course-cell';

                    // æŸ¥æ‰¾è¯¥æ—¥æœŸè¯¥æ—¶é—´æ®µçš„è¯¾ç¨‹
                    const courses = scheduleData.filter(s => {
                        return s.courseDate === date && s.startTime.startsWith(slot.time.split('-')[0]);
                    });

                    if (courses.length === 0) {
                        td.innerHTML = '<div class="empty-cell">-</div>';
                    } else {
                        // æ”¶é›†æ‰€æœ‰å­¦ç”Ÿ
                        const allStudents = [];
                        courses.forEach(course => {
                            if (course.students && course.students.length > 0) {
                                course.students.forEach(student => {
                                    allStudents.push({
                                        studentId: student.studentId,
                                        name: student.studentName,
                                        isOnLeave: student.isOnLeave || false,
                                        courseDate: course.courseDate,
                                        semesterId: course.semesterId
                                    });
                                });
                            }
                        });

                        // æ¸²æŸ“å­¦ç”Ÿåå­—
                        const studentListDiv = document.createElement('div');
                        studentListDiv.className = 'student-list';

                        allStudents.forEach(s => {
                            const span = document.createElement('span');
                            span.className = `student-name ${s.isOnLeave ? 'on-leave' : ''}`;
                            span.textContent = s.name;
                            span.onclick = () => toggleLeave(s);
                            studentListDiv.appendChild(span);
                        });

                        td.appendChild(studentListDiv);
                    }

                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        // æ ¼å¼åŒ–æ—¥æœŸ MM-DD
        function formatDateShort(date) {
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${month}-${day}`;
        }

        // æ˜¾ç¤ºåŠ è½½ä¸­
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('empty').style.display = 'none';
            document.getElementById('scheduleWrapper').style.display = 'none';
        }

        // éšè—åŠ è½½ä¸­
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // åˆ‡æ¢è¯·å‡çŠ¶æ€
        async function toggleLeave(studentInfo) {
            const { studentId, name, isOnLeave, courseDate, semesterId } = studentInfo;

            if (isOnLeave) {
                // å·²è¯·å‡ï¼Œç¡®è®¤æ˜¯å¦å–æ¶ˆè¯·å‡
                if (!confirm(`ç¡®å®šè¦å–æ¶ˆ ${name} åœ¨ ${courseDate} çš„è¯·å‡å—ï¼Ÿ`)) {
                    return;
                }

                try {
                    // æŸ¥è¯¢è¯¥å­¦ç”Ÿåœ¨è¯¥æ—¥æœŸçš„è¯·å‡è®°å½•
                    const response = await fetch(`${API_BASE}/student-leave/student/${studentId}`);
                    const leaves = await response.json();

                    // æ‰¾åˆ°å¯¹åº”æ—¥æœŸçš„è¯·å‡è®°å½•
                    const targetLeave = leaves.find(leave => {
                        const startDate = leave.startDate;
                        const endDate = leave.endDate;
                        return courseDate >= startDate && courseDate <= endDate;
                    });

                    if (targetLeave) {
                        // åˆ é™¤è¯·å‡è®°å½•
                        const deleteResponse = await fetch(`${API_BASE}/student-leave/${targetLeave.leaveId}`, {
                            method: 'DELETE'
                        });

                        if (deleteResponse.ok) {
                            alert('å·²å–æ¶ˆè¯·å‡');
                            // é‡æ–°åŠ è½½è¯¾ç¨‹è¡¨
                            loadSchedule();
                        } else {
                            alert('å–æ¶ˆè¯·å‡å¤±è´¥');
                        }
                    } else {
                        alert('æœªæ‰¾åˆ°è¯·å‡è®°å½•');
                    }
                } catch (error) {
                    console.error('å–æ¶ˆè¯·å‡å¤±è´¥:', error);
                    alert('å–æ¶ˆè¯·å‡å¤±è´¥ï¼š' + error.message);
                }
            } else {
                // æœªè¯·å‡ï¼Œå¼¹å‡ºè¾“å…¥æ¡†è®©ç”¨æˆ·è¾“å…¥è¯·å‡åŸå› 
                const reason = prompt(`è¯·è¾“å…¥ ${name} åœ¨ ${courseDate} çš„è¯·å‡åŸå› ï¼š`);
                if (reason === null || reason.trim() === '') {
                    return;
                }

                try {
                    // åˆ›å»ºè¯·å‡è®°å½•
                    const response = await fetch(`${API_BASE}/student-leave`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            studentId: studentId,
                            semesterId: semesterId,
                            startDate: courseDate,
                            endDate: courseDate,
                            leaveType: 'å…¶ä»–',
                            reason: reason.trim()
                        })
                    });

                    if (response.ok) {
                        alert('å·²è®¾ç½®è¯·å‡');
                        // é‡æ–°åŠ è½½è¯¾ç¨‹è¡¨
                        loadSchedule();
                    } else {
                        alert('è®¾ç½®è¯·å‡å¤±è´¥');
                    }
                } catch (error) {
                    console.error('è®¾ç½®è¯·å‡å¤±è´¥:', error);
                    alert('è®¾ç½®è¯·å‡å¤±è´¥ï¼š' + error.message);
                }
            }
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = 'âŒ ' + message;
            errorDiv.style.display = 'block';
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('teacherSelect').addEventListener('change', loadSchedule);
        document.getElementById('semesterSelect').addEventListener('change', loadSchedule);

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
