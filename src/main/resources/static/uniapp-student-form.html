<template>
  <view class="container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <view class="title">ğŸ“ å½•å…¥å­¦ç”Ÿä¿¡æ¯</view>

    <!-- è¡¨å•åŒºåŸŸ -->
    <view class="form">
      <!-- å­¦ç”Ÿå§“å -->
      <view class="form-item">
        <text class="label">å­¦ç”Ÿå§“å <text class="required">*</text></text>
        <input
          class="input"
          v-model="formData.studentName"
          placeholder="è¯·è¾“å…¥å­¦ç”Ÿå§“å"
        />
      </view>

      <!-- æ€§åˆ« -->
      <view class="form-item">
        <text class="label">æ€§åˆ«</text>
        <radio-group @change="onGenderChange">
          <label class="radio">
            <radio value="ç”·" :checked="formData.sex === 'ç”·'" />
            <text>ç”·</text>
          </label>
          <label class="radio">
            <radio value="å¥³" :checked="formData.sex === 'å¥³'" />
            <text>å¥³</text>
          </label>
        </radio-group>
      </view>

      <!-- å¹´çº§ -->
      <view class="form-item">
        <text class="label">å¹´çº§ <text class="required">*</text></text>
        <input
          class="input"
          v-model="formData.grade"
          type="number"
          placeholder="è¯·è¾“å…¥å¹´çº§ï¼ˆå¦‚ï¼š10ï¼‰"
        />
      </view>

      <!-- å­¦æ®µ -->
      <view class="form-item">
        <text class="label">å­¦æ®µ</text>
        <picker
          mode="selector"
          :range="levelOptions"
          @change="onLevelChange"
        >
          <view class="picker">
            {{ formData.level || 'è¯·é€‰æ‹©å­¦æ®µ' }}
            <text class="arrow">â€º</text>
          </view>
        </picker>
      </view>

      <!-- å®¶é•¿å§“å -->
      <view class="form-item">
        <text class="label">å®¶é•¿å§“å</text>
        <input
          class="input"
          v-model="formData.parentName"
          placeholder="è¯·è¾“å…¥å®¶é•¿å§“å"
        />
      </view>

      <!-- å®¶é•¿æ‰‹æœºå· -->
      <view class="form-item">
        <text class="label">å®¶é•¿æ‰‹æœºå·</text>
        <input
          class="input"
          v-model="formData.parentPhone"
          type="number"
          maxlength="11"
          placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
        />
      </view>

      <!-- çŠ¶æ€ -->
      <view class="form-item">
        <text class="label">çŠ¶æ€</text>
        <picker
          mode="selector"
          :range="statusOptions"
          @change="onStatusChange"
        >
          <view class="picker">
            {{ formData.status || 'è¯·é€‰æ‹©çŠ¶æ€' }}
            <text class="arrow">â€º</text>
          </view>
        </picker>
      </view>
    </view>

    <!-- æäº¤æŒ‰é’® -->
    <view class="btn-group">
      <button class="btn btn-primary" @click="submit">æäº¤</button>
      <button class="btn btn-secondary" @click="reset">é‡ç½®</button>
    </view>

    <!-- æç¤ºä¿¡æ¯ -->
    <view class="tips">
      <text class="tips-text">æç¤ºï¼šå¸¦ * çš„ä¸ºå¿…å¡«é¡¹</text>
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      // è¡¨å•æ•°æ®
      formData: {
        studentName: '',      // å­¦ç”Ÿå§“å
        sex: '',             // æ€§åˆ«
        grade: '',           // å¹´çº§
        level: '',           // å­¦æ®µ
        parentName: '',      // å®¶é•¿å§“å
        parentPhone: '',     // å®¶é•¿æ‰‹æœºå·
        status: 'åœ¨è¯»'       // çŠ¶æ€
      },

      // å­¦æ®µé€‰é¡¹
      levelOptions: ['å°å­¦', 'åˆä¸­', 'é«˜ä¸­'],

      // çŠ¶æ€é€‰é¡¹
      statusOptions: ['åœ¨è¯»', 'åœè¯¾', 'æ¯•ä¸š', 'é€€è´¹']
    }
  },

  methods: {
    // æ€§åˆ«é€‰æ‹©å˜åŒ–
    onGenderChange(e) {
      this.formData.sex = e.detail.value;
    },

    // å­¦æ®µé€‰æ‹©å˜åŒ–
    onLevelChange(e) {
      this.formData.level = this.levelOptions[e.detail.value];
    },

    // çŠ¶æ€é€‰æ‹©å˜åŒ–
    onStatusChange(e) {
      this.formData.status = this.statusOptions[e.detail.value];
    },

    // æäº¤è¡¨å•
    async submit() {
      // 1. è¡¨å•éªŒè¯
      if (!this.validate()) {
        return;
      }

      // 2. æ˜¾ç¤ºåŠ è½½æç¤º
      uni.showLoading({
        title: 'æäº¤ä¸­...'
      });

      try {
        // 3. è°ƒç”¨åç«¯API
        const res = await this.saveStudent();

        // 4. æäº¤æˆåŠŸ
        uni.hideLoading();
        uni.showToast({
          title: 'å½•å…¥æˆåŠŸ',
          icon: 'success'
        });

        // 5. é‡ç½®è¡¨å•
        this.reset();

      } catch (error) {
        uni.hideLoading();
        uni.showToast({
          title: 'å½•å…¥å¤±è´¥',
          icon: 'none'
        });
        console.error('ä¿å­˜å¤±è´¥:', error);
      }
    },

    // ä¿å­˜å­¦ç”Ÿï¼ˆè°ƒç”¨APIï¼‰
    async saveStudent() {
      // å¼€å‘ç¯å¢ƒï¼šæœ¬åœ°æµ‹è¯•
      // ç”Ÿäº§ç¯å¢ƒï¼šè¿æ¥åç«¯API
      const apiUrl = 'http://localhost:8080/api/student';

      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(this.formData)
      });

      if (!response.ok) {
        throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
      }

      const data = await response.json();
      if (!data) {
        throw new Error('ä¿å­˜å¤±è´¥');
      }

      return data;
    },

    // è¡¨å•éªŒè¯
    validate() {
      // éªŒè¯å§“å
      if (!this.formData.studentName) {
        uni.showToast({
          title: 'è¯·è¾“å…¥å­¦ç”Ÿå§“å',
          icon: 'none'
        });
        return false;
      }

      // éªŒè¯å¹´çº§
      if (!this.formData.grade) {
        uni.showToast({
          title: 'è¯·è¾“å…¥å¹´çº§',
          icon: 'none'
        });
        return false;
      }

      // éªŒè¯æ‰‹æœºå·æ ¼å¼
      if (this.formData.parentPhone) {
        const phoneReg = /^1[3-9]\d{9}$/;
        if (!phoneReg.test(this.formData.parentPhone)) {
          uni.showToast({
            title: 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®',
            icon: 'none'
          });
          return false;
        }
      }

      return true;
    },

    // é‡ç½®è¡¨å•
    reset() {
      this.formData = {
        studentName: '',
        sex: '',
        grade: '',
        level: '',
        parentName: '',
        parentPhone: '',
        status: 'åœ¨è¯»'
      };
    }
  }
}
</script>

<style scoped>
.container {
  padding: 20px;
  background: #f5f5f5;
  min-height: 100vh;
}

.title {
  font-size: 24px;
  font-weight: bold;
  text-align: center;
  margin-bottom: 30px;
  color: #333;
}

.form {
  background: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.form-item {
  margin-bottom: 20px;
  border-bottom: 1px solid #f0f0f0;
  padding-bottom: 15px;
}

.form-item:last-child {
  border-bottom: none;
}

.label {
  display: block;
  font-size: 14px;
  color: #333;
  font-weight: bold;
  margin-bottom: 10px;
}

.required {
  color: #ff4d4f;
}

.input {
  width: 100%;
  height: 40px;
  border: 1px solid #ddd;
  border-radius: 5px;
  padding: 0 10px;
  font-size: 14px;
}

.radio {
  display: inline-block;
  margin-right: 20px;
}

.radio text {
  margin-left: 5px;
}

.picker {
  height: 40px;
  border: 1px solid #ddd;
  border-radius: 5px;
  padding: 0 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 14px;
  color: #333;
}

.arrow {
  color: #999;
  font-size: 20px;
}

.btn-group {
  margin-top: 30px;
  display: flex;
  gap: 15px;
}

.btn {
  flex: 1;
  height: 44px;
  border: none;
  border-radius: 5px;
  font-size: 16px;
}

.btn-primary {
  background: #007AFF;
  color: white;
}

.btn-secondary {
  background: #f0f0f0;
  color: #333;
}

.tips {
  margin-top: 20px;
  text-align: center;
}

.tips-text {
  font-size: 12px;
  color: #999;
}
</style>
